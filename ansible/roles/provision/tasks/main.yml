# packages tasks
- name: Packages - Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  when: ansible_os_family | default('') == "Debian"
  tags: packages

- name: Packages - Upgrade all
  ansible.builtin.apt:
    upgrade: dist
  when:
    - ansible_os_family | default('') == "Debian"
    - server_packages_enabled
  tags: packages

- name: Packages - Install base
  ansible.builtin.apt:
    name: "{{ server_base_packages }}"
    state: present
  when: ansible_os_family | default('') == "Debian"
  tags: packages

- name: Packages - Set timezone
  ansible.builtin.timezone:
    name: "{{ server_timezone }}"
  tags: packages

- name: Packages - Remove unnecessary packages
  ansible.builtin.apt:
    autoremove: true
  when: ansible_os_family | default('') == "Debian"
  tags: packages

- name: Packages - Clean apt cache
  ansible.builtin.apt:
    autoclean: true
  when: ansible_os_family | default('') == "Debian"
  tags: packages

# firewall tasks
- name: Firewall - Reset to default
  ansible.builtin.ufw:
    state: reset
  when:
    - firewall_enabled
    - not ansible_check_mode
  tags: firewall

- name: Firewall - Set default incoming policy to deny
  ansible.builtin.ufw:
    direction: incoming
    policy: deny
  when: firewall_enabled
  notify: Reload ufw
  tags: firewall

- name: Firewall - Set default outgoing policy to allow
  ansible.builtin.ufw:
    direction: outgoing
    policy: allow
  when: firewall_enabled
  notify: Reload ufw
  tags: firewall

- name: Firewall - Allow ssh first
  ansible.builtin.ufw:
    rule: allow
    port: "22"
    proto: tcp
    comment: "SSH access"
  when: firewall_enabled
  notify: Reload ufw
  tags: firewall

- name: Firewall - Allow iap tunnel range
  ansible.builtin.ufw:
    rule: allow
    src: "{{ gcp_iap_range }}"
    port: "22"
    proto: tcp
    comment: "GCP IAP tunnel"
  when: firewall_enabled
  notify: Reload ufw
  tags: firewall

- name: Firewall - Allow public ports
  ansible.builtin.ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
    comment: "Public port {{ item }}"
  loop: "{{ firewall_public_tcp_ports }}"
  when: firewall_enabled
  notify: Reload ufw
  tags: firewall

- name: Firewall - Allow GCP health check ranges
  ansible.builtin.ufw:
    rule: allow
    src: "{{ item }}"
    port: "{{ gcp_health_check_port }}"
    proto: tcp
    comment: "GCP health check"
  loop: "{{ gcp_health_check_ranges }}"
  when: firewall_enabled
  notify: Reload ufw
  tags: firewall

- name: Firewall - Enable UFW
  ansible.builtin.ufw:
    state: enabled
  when:
    - firewall_enabled
    - not ansible_check_mode
  tags: firewall

- name: Firewall - Show status
  ansible.builtin.command: ufw status verbose
  register: ufw_status
  changed_when: false
  when: firewall_enabled
  tags: firewall

- name: Firewall - Display status
  ansible.builtin.debug:
    var: ufw_status.stdout_lines
  when: firewall_enabled
  tags: firewall

# nginx tasks
- name: Nginx - Install
  ansible.builtin.apt:
    name: nginx
    state: present
  when:
    - ansible_os_family | default('') == "Debian"
    - nginx_state == "present"
  tags: nginx

- name: Nginx - Remove
  ansible.builtin.apt:
    name: nginx
    state: absent
    purge: true
  when:
    - ansible_os_family | default('') == "Debian"
    - nginx_state == "absent"
  tags: nginx

- name: Nginx - Check if installed
  ansible.builtin.stat:
    path: /usr/sbin/nginx
  register: nginx_installed
  changed_when: false
  failed_when: false
  tags: nginx

- name: Nginx - Ensure running
  ansible.builtin.systemd:
    name: nginx
    state: started
    enabled: true
  when:
    - nginx_state == "present"
    - nginx_installed.stat.exists | default(false)
  tags: nginx

# ssh tasks
- name: SSH - Disable root login
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^#?PermitRootLogin"
    line: "PermitRootLogin {{ ssh_permit_root_login }}"
  notify: Restart ssh
  when: ssh_hardening_enabled
  tags: ssh

- name: SSH - Disable password authentication
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^#?PasswordAuthentication"
    line: "PasswordAuthentication {{ ssh_password_authentication }}"
  notify: Restart ssh
  when: ssh_hardening_enabled
  tags: ssh

- name: SSH - Set max auth tries
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^#?MaxAuthTries"
    line: "MaxAuthTries {{ ssh_max_auth_tries }}"
  notify: Restart ssh
  when: ssh_hardening_enabled
  tags: ssh

# journald tasks
- name: Journald - max retention
  ansible.builtin.lineinfile:
    path: /etc/systemd/journald.conf
    regexp: "^#?MaxRetentionSec="
    line: "MaxRetentionSec={{ journald_max_retention }}"
  notify: Restart journald
  tags: logging

- name: Journald - max disk size
  ansible.builtin.lineinfile:
    path: /etc/systemd/journald.conf
    regexp: "^#?SystemMaxUse="
    line: "SystemMaxUse={{ journald_max_disk_size }}"
  notify: Restart journald
  tags: logging

# swap tasks
- name: Swap - Check if swap file exists
  ansible.builtin.stat:
    path: "{{ swap_path }}"
  register: swap_file
  tags: tuning

- name: Swap - Create file
  ansible.builtin.command: fallocate -l {{ swap_size }} {{ swap_path }}
  check_mode: no
  when:
    - swap_enabled
    - not swap_file.stat.exists
  tags: tuning

- name: Swap - Set permissions
  ansible.builtin.file:
    path: "{{ swap_path }}"
    mode: '0600'
  when:
    - swap_enabled
    - not swap_file.stat.exists
  tags: tuning

- name: Swap - Make swap
  ansible.builtin.command: mkswap {{ swap_path }}
  check_mode: no
  when:
    - swap_enabled
    - not swap_file.stat.exists
  tags: tuning

- name: Swap - Enable
  ansible.builtin.command: swapon {{ swap_path }}
  check_mode: no
  when:
    - swap_enabled
    - not swap_file.stat.exists
  tags: tuning

- name: Swap - Add to fstab
  ansible.builtin.lineinfile:
    path: /etc/fstab
    line: '{{ swap_path }} none swap sw 0 0'
    state: present
  when: swap_enabled
  tags: tuning

- name: Swap - Set swappiness
  ansible.builtin.sysctl:
    name: vm.swappiness
    value: "{{ swap_swappiness }}"
    state: present
    reload: true
  when: swap_enabled
  tags: tuning

# limits tasks
- name: Set file descriptor limits - soft
  ansible.builtin.lineinfile:
    path: /etc/security/limits.conf
    line: "* soft nofile {{ limits_nofile_soft }}"
    state: present
  tags: tuning

- name: Set file descriptor limits - hard
  ansible.builtin.lineinfile:
    path: /etc/security/limits.conf
    line: "* hard nofile {{ limits_nofile_hard }}"
    state: present
  tags: tuning

# summary
- name: Display provisioning summary
  ansible.builtin.debug:
    msg: |
      ==========================================
      Provisioning Complete!
      ==========================================
      Hostname:     {{ ansible_hostname | default('N/A') }}
      OS:           {{ ansible_distribution | default('N/A') }} {{ ansible_distribution_version | default('') }}                
      Timezone:     {{ server_timezone }}
      Firewall:     {{ 'Enabled' if firewall_enabled else 'Disabled' }}
      SSH Hardened: {{ 'Yes' if ssh_hardening_enabled else 'No' }}
      Swap:         {{ swap_size if swap_enabled else 'Disabled' }}
      Nginx:        {{ nginx_state | default('present') }}
      ==========================================
      
      Firewall Ports:
      - Port 22:   SSH (IAP tunnel)
      - Port 80:   Nginx (public)
      - Port 8080: NOT exposed (localhost only)
      ==========================================