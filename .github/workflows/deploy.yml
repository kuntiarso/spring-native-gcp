name: Deploy App
on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Commit SHA of the build to deploy (check build workflow summary)'
        required: true
        type: string
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
permissions:
  id-token: write
env:
  APP_DIR: /app
  APP_NAME: native-workshop
  APP_START_SH: start.sh
  GCP_PROJECT_ID: project-788fce37-8e64-49f5-bcf
  GCP_WORKLOAD_ID: projects/907266880390/locations/global/workloadIdentityPools/github-actions-pool/providers/github-native-workshop-repo
jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Check build exists
        id: build-check
        uses: actions/github-script@v8
        with:
          script: |
            const { data: { workflow_runs } } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build.yml',
              head_sha: '${{ github.event.inputs.commit_sha }}',
              status: 'success'
            });
            if (workflow_runs.length === 0) {
              console.log(`No successful build found for SHA: ${{ github.event.inputs.commit_sha }}`);
              core.setOutput('exists', 'false');
              return;
            }
            const buildId = workflow_runs[0].id;
            console.log(`Found workflow run ID: ${buildId}`);
            core.setOutput('build_id', buildId);
            core.setOutput('exists', 'true');
      - name: Download artifact from build id
        if: steps.build-check.outputs.exists == 'true'
        id: artifact-download
        uses: actions/download-artifact@v5
        continue-on-error: true
        with:
          name: ${{ env.APP_NAME }}-${{ github.event.inputs.commit_sha }}
          path: ./artifact
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: '${{ steps.build-check.outputs.build_id }}'
      - name: Verify artifact exists
        id: artifact-verify
        run: |
          if [ -f "./artifact/${{ env.APP_NAME }}" ]; then
            echo "Artifact found: ./artifact/${{ env.APP_NAME }}"
            ls -la ./artifact/
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Artifact not found!"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      - name: Skip deploy summary
        if: steps.artifact-verify.outputs.exists != 'true'
        run: |
          echo "## Deployment Skipped! :warning:" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit SHA:** ${{ github.event.inputs.commit_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Reason:** Artifact not found or download failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Run the **Build Native Image** workflow first" >> $GITHUB_STEP_SUMMARY
          echo "2. Use commit SHA: \`${{ github.event.inputs.commit_sha }}\`" >> $GITHUB_STEP_SUMMARY
          exit 1
      - name: Setup gcp env vars
        if: steps.artifact-verify.outputs.exists == 'true'
        run: |
          if [ "${{ github.event.inputs.environment }}" == "prod" ]; then
            echo "GCP_ZONE=us-central1-c" >> $GITHUB_ENV
            echo "GCP_INSTANCE=prod-instance" >> $GITHUB_ENV
          else
            echo "GCP_ZONE=us-central1-c" >> $GITHUB_ENV
            echo "GCP_INSTANCE=gcp-remote-instance-20251214-182233" >> $GITHUB_ENV
          fi
      - name: Authenticate to gcp
        if: steps.artifact-verify.outputs.exists == 'true'
        uses: google-github-actions/auth@v3
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          workload_identity_provider: ${{ env.GCP_WORKLOAD_ID }}
      - name: Setup gcloud sdk
        if: steps.artifact-verify.outputs.exists == 'true'
        uses: google-github-actions/setup-gcloud@v3
      - name: Deploy native image to vm
        if: steps.artifact-verify.outputs.exists == 'true'
        run: |
          chmod +x ./artifact/${{ env.APP_NAME }}
          gcloud compute ssh ${{ env.GCP_INSTANCE }} --zone=${{ env.GCP_ZONE }} --command="sudo mkdir -p ${{ env.APP_DIR }} && sudo chown \$(whoami):\$(whoami) ${{ env.APP_DIR }}"
          gcloud compute scp ./artifact/${{ env.APP_NAME }} ${{ env.GCP_INSTANCE }}:${{ env.APP_DIR }}/${{ env.APP_NAME }} --zone=${{ env.GCP_ZONE }}
          gcloud compute scp ./${{ env.APP_START_SH }} ${{ env.GCP_INSTANCE }}:${{ env.APP_DIR }}/${{ env.APP_START_SH }} --zone=${{ env.GCP_ZONE }}
          gcloud compute ssh ${{ env.GCP_INSTANCE }} --zone=${{ env.GCP_ZONE }} --command="chmod +x ${{ env.APP_DIR }}/${{ env.APP_START_SH }} && ${{ env.APP_DIR }}/${{ env.APP_START_SH }}"
      - name: Deployment summary
        if: steps.artifact-verify.outputs.exists == 'true'
        run: |
          echo "## Deployment Complete! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **VM:** ${{ env.GCP_INSTANCE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **App Location:** ${{ env.APP_DIR }}/${{ env.APP_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build SHA:** ${{ github.event.inputs.commit_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID:** ${{ steps.build-check.outputs.build_id }}" >> $GITHUB_STEP_SUMMARY